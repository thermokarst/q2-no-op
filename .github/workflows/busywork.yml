name: busywork

on: [push]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: fetch source
        uses: actions/checkout@v2
        with:
          path: source

      - name: set up miniconda
        uses: goanpeca/setup-miniconda@v1
        with:
          auto-update-conda: true
          python-version: 3.6

      - name: set up conda build
        run: conda install -n base -q -y -c defaults --override-channels conda-build conda-verify

      - name: build conda package
        run: |
          cd source
          conda build \
            -c conda-forge \
            -c bioconda \
            -c qiime2 \
            -c defaults \
            --override-channels --output-folder ../package ci/recipe

      - name: zip built package
        run: zip -r ./package.zip ./package

      - name: store built package
        uses: actions/upload-artifact@v1
        with:
          name: package
          path: ./package.zip

  test:
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: fetch built package
        uses: actions/download-artifact@v1
        with:
          name: package

      - name: unzip built package
        run: unzip ./package/package.zip -d ./conda-build

      - name: create conda testing env
        run: conda create -q -y -p ./test-env

      - name: install plugin and dependencies
        run: |
          conda install -p ./test-env -q -y \
            -c ./conda-build/package \
            -c conda-forge \
            -c bioconda \
            -c qiime2 \
            -c defaults \
            --override-channels q2-no-op pytest

      - name: run unit tests
        run: conda run -p ./test-env py.test --pyargs q2_no_op